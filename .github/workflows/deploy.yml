name: Deploy FincFlow

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: SSH and Deploy
        uses: appleboy/ssh-action@v1.0.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.REMOTE_PORT || 22 }}
          timeout: 300s
          envs: GITHUB_TOKEN
          script: |
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
            
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
            
            # å‡†å¤‡å·¥ä½œç›®å½•
            mkdir -p /home/fincflow/app
            cd /home/fincflow/app
            
            # å¦‚æœç›®å½•å·²å­˜åœ¨ï¼Œå…ˆæ‹‰å–æœ€æ–°ä»£ç ï¼Œå¦åˆ™å…‹éš†
            if [ -d "risk_management_enterprise" ]; then
              echo "ğŸ“¥ æ›´æ–°ç°æœ‰ä»£ç ..."
              cd risk_management_enterprise
              # ä½¿ç”¨ token æ›´æ–°ä»£ç 
              git fetch https://x-access-token:$GITHUB_TOKEN@github.com/fincflow/risk_management_enterprise.git main || true
              git reset --hard FETCH_HEAD || true
              git clean -fd || true
            else
              echo "ğŸ“¥ å…‹éš†ä»“åº“ï¼ˆä½¿ç”¨ GitHub Tokenï¼Œæ— éœ€é…ç½®æœåŠ¡å™¨æƒé™ï¼‰..."
              # ä½¿ç”¨ GitHub Token å…‹éš†ï¼Œæ— éœ€åœ¨æœåŠ¡å™¨ä¸Šé…ç½® Git æƒé™
              git clone https://x-access-token:$GITHUB_TOKEN@github.com/fincflow/risk_management_enterprise.git
              cd risk_management_enterprise
            fi
            
            echo "âœ… ä»£ç æ›´æ–°å®Œæˆ"
            
            # å®‰è£…ç³»ç»Ÿä¾èµ–
            echo "ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–..."
            sudo apt-get update -qq || true
            sudo apt-get install -y python3-pip python3-venv git > /dev/null 2>&1 || true
            
            # ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ
            echo "ğŸ è®¾ç½® Python è™šæ‹Ÿç¯å¢ƒ..."
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            source venv/bin/activate
            
            # å‡çº§ pip å¹¶å®‰è£…ä¾èµ–
            echo "ğŸ“š å®‰è£… Python ä¾èµ–..."
            pip install --upgrade pip -q || true
            pip install -r requirements.txt || {
              echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥ï¼ŒæŸ¥çœ‹é”™è¯¯ï¼š"
              pip install -r requirements.txt
              exit 1
            }
            
            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
            
            # åœæ­¢æ—§æœåŠ¡
            echo "ğŸ›‘ åœæ­¢æ—§æœåŠ¡..."
            pkill -f "uvicorn main:app" || true
            sleep 2
            
            # æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
            if lsof -ti:8000 > /dev/null 2>&1; then
              echo "âš ï¸ ç«¯å£ 8000 è¢«å ç”¨ï¼Œå¼ºåˆ¶é‡Šæ”¾..."
              lsof -ti:8000 | xargs kill -9 || true
              sleep 1
            fi
            
            # å¯åŠ¨æ–°æœåŠ¡ï¼ˆä½¿ç”¨è™šæ‹Ÿç¯å¢ƒä¸­çš„ pythonï¼‰
            echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
            nohup venv/bin/python -m uvicorn main:app --host 0.0.0.0 --port 8000 > /home/fincflow/app/log.txt 2>&1 &
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 5
            
            # éªŒè¯æœåŠ¡æ˜¯å¦å¯åŠ¨
            if pgrep -f "uvicorn main:app" > /dev/null; then
              echo "âœ… æœåŠ¡è¿›ç¨‹å·²å¯åŠ¨"
              # å†æ¬¡éªŒè¯ç«¯å£
              sleep 2
              if curl -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ…âœ… Deploy Success! Service is running and healthy."
              else
                echo "âš ï¸ æœåŠ¡è¿›ç¨‹å­˜åœ¨ä½†å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
                tail -20 /home/fincflow/app/log.txt || true
                echo "âœ… æœåŠ¡å·²å¯åŠ¨ï¼ˆå¥åº·æ£€æŸ¥å¯èƒ½æš‚æ—¶å¤±è´¥ï¼‰"
              fi
            else
              echo "âŒ Deploy Failed! Service did not start."
              echo "æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼š"
              cat /home/fincflow/app/log.txt || true
              exit 1
            fi